{% extends 'base.html.twig' %}

{% block title %}
    {{ userData.differentUser ? 'Profil de ' ~ userData.username : 'Mon profil' }}
{% endblock %}

{% block body %}

{% include 'header.html.twig' %}    

<div class="flex min-h-[calc(100vh-4rem)] bg-gray-100 text-white ubuntu-sans-medium" style="background: linear-gradient(to right, rgba(32, 32, 32, 1) 0%, rgba(5, 5, 5, 1) 35%, rgba(5, 5, 5, 1) 65%, rgba(32, 32, 32, 1) 100%);">
    <div id="postsContainer" class="w-2/5 h-full mx-auto bg-[#1a1a1a] shadow-md my-8 rounded-t-2xl rounded-b-2xl border-x-[1px] border-b-[1px] border-neutral-800">
        <!-- Cover Image -->
        <div class="h-48 w-full relative rounded-t-2xl">
            {% if userData.profileBackgroundLink %}
                <img id="profileBackground" src="/img/uploads/pbi{{ asset(userData.profileBackgroundLink) }}"  class="w-full h-full object-cover rounded-t-2xl border-2 cursor-default" style="border-color: {{ userData.profileBorderColor }}" draggable="false">                
            {% else %}
                <img id="profileBackground" src="" class="bg-black w-full h-full object-cover rounded-t-2xl border-2 cursor-default" style="border-color: {{ userData.profileBorderColor }}" draggable="false">                
            {% endif %}
            
            <!-- Profile Picture -->
            <div class="absolute bottom-0 left-0 right-0 flex justify-center items-center transform translate-y-1/2">
                {% if userData.profilePictureLink %}
                    <img src="/img/uploads/pfp{{ asset(userData.profilePictureLink) }}" width="128" height="128" class="w-32 h-32 rounded-full border-2" style="border-color: {{ userData.profileBorderColor }}" draggable="false">
                {% else %}
                    <img src="/img/uploads/pfp/default.gif" width="128" height="128" class="w-32 h-32 rounded-full border-2" style="border-color: {{ userData.profileBorderColor }}" draggable="false">
                {% endif %}     
            </div>
        </div>

        <!-- Profile Information -->
        <div class="p-4 pt-16 border-neutral-800">
            <div class="flex justify-center">
                <div class="flex flex-col gap-2">
                    <h1 class="mt-1 text-xl text-center ubuntu-sans-bold">{{userData.username}}</h1>
                    {#<p class="text-gray-600 dark:text-gray-400">@user</p>#}
                    <p class="text-center" style="color: {{userData.description ? 'white' : '#9ca3af'}}">
                        {{ userData.description | default('Description par d√©faut') }}
                    </p>
                </div>

                {#{% if userData.differentUser %}
                    <button class="flex py-3 font-semibold text-white duration-200 border border-gray-600 rounded-full cursor-pointer bg-gradient-to-r from-gray-800 to-black px-7 hover:scale-105 hover:text-gray-500 hover:border-gray-800 hover:from-black hover:to-gray-900">
                        Ajouter
                    </button>
                {% endif %}#}
            </div>
        </div>

        <!-- Posts -->
        {% include 'post/_posts.html.twig' with {'posts': userData.posts} %}
        <script src="{{ asset('js/post.js') }}"></script>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        window.scrollTo(0, 0);
    });

    let offset = 10;
    const limit = 10;
    let hasMorePosts = true;

    window.addEventListener('scroll', () => {
        if (((window.innerHeight + window.scrollY) >= document.body.offsetHeight) && hasMorePosts) {
            loadMorePosts();
        }
    });

    function loadMorePosts() {
        const pathParts = window.location.pathname.split('/');
        const username = pathParts[2]; 

        fetch(`/profile/${username}/load-more-posts?offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('postsContainer').insertAdjacentHTML('beforeend', data.html);
                offset += limit;

                if (!data.hasMore) {
                    hasMorePosts = false;
                }
            })
            .catch(error => console.error('Erreur lors du chargement des posts:', error));
    }
</script>
{% endblock %}